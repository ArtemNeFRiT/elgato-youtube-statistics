<!DOCTYPE HTML>
<html>

<head>
    <title>com.nefrit.youtube.statistics</title>
    <meta charset="utf-8"/>
</head>

<body>
<script>

    const videoId = "Yr_7sd3x-cQ";
    const apiKey = "";

    let websocket = null;
    let pluginUUID = null;

    const DestinationEnum = Object.freeze({"HARDWARE_AND_SOFTWARE": 0, "HARDWARE_ONLY": 1, "SOFTWARE_ONLY": 2})

    let timer;

    const viewsAction = {
        type: "com.nefrit.youtube.views",

        onKeyDown: function (context, settings, coordinates, userDesiredState) {
            timer = setTimeout(function () {
                viewsAction.SetTitle(context, 0);
            }, 1500);
        },

        onKeyUp: function (context, settings, coordinates, userDesiredState, videoId) {
            clearTimeout(timer);

            const url = "https://www.googleapis.com/youtube/v3/videos?part=statistics&id=" + videoId + "&key=" + apiKey;

            fetch(url)
                .then(response => response.json())
                .then(responseJSON => {
                    const viewCount = responseJSON.items[0].statistics.viewCount;
                    this.SetTitle(context, viewCount);
                })
                .catch(error => {
                    console.error(error);
                    this.SetTitle(context, "Ошибка");
                });
        },

        onWillAppear: function (context, settings, coordinates) {
        },

        SetTitle: function (context, title) {
            const json = {
                "event": "setTitle",
                "context": context,
                "payload": {
                    "title": "" + title,
                    "target": DestinationEnum.HARDWARE_AND_SOFTWARE
                }
            };

            websocket.send(JSON.stringify(json));
        },
    };

    var likesAction = {
        type: "com.nefrit.youtube.likes",

        onKeyDown: function (context, settings, coordinates, userDesiredState) {
            timer = setTimeout(function () {
                likesAction.SetTitle(context, 0);
            }, 1500);
        },

        onKeyUp: function (context, settings, coordinates, userDesiredState) {
            clearTimeout(timer);

            const url = "https://www.googleapis.com/youtube/v3/videos?part=statistics&id=" + videoId + "&key=" + apiKey;

            fetch(url)
                .then(response => response.json())
                .then(responseJSON => {
                    const likesCount = responseJSON.items[0].statistics.likeCount;
                    this.SetTitle(context, likesCount);
                })
                .catch(error => {
                    console.error(error);
                    this.SetTitle(context, "Ошибка");
                });
        },

        SetTitle: function (context, title) {
            const json = {
                "event": "setTitle",
                "context": context,
                "payload": {
                    "title": "" + title,
                    "target": DestinationEnum.HARDWARE_AND_SOFTWARE
                }
            };

            websocket.send(JSON.stringify(json));
        },
    }

    function connectElgatoStreamDeckSocket(inPort, inPluginUUID, inRegisterEvent, inInfo) {
        pluginUUID = inPluginUUID

        websocket = new WebSocket("ws://127.0.0.1:" + inPort);

        function registerPlugin(inPluginUUID) {
            const json = {
                "event": inRegisterEvent,
                "uuid": inPluginUUID
            };

            websocket.send(JSON.stringify(json));
        }

        websocket.onopen = function () {
            registerPlugin(pluginUUID);
        };

        websocket.onmessage = function (evt) {
            const jsonObj = JSON.parse(evt.data);
            const event = jsonObj['event'];
            const action = jsonObj['action'];
            const context = jsonObj['context'];

            const jsonPayload = jsonObj['payload'];
            const settings = jsonPayload['settings'];
            const coordinates = jsonPayload['coordinates'];
            const userDesiredState = jsonPayload['userDesiredState'];


            const actions = {
                "com.nefrit.youtube.views": {
                    "keyDown": () => viewsAction.onKeyDown(context, settings, coordinates, userDesiredState),
                    "keyUp": () => viewsAction.onKeyUp(context, settings, coordinates, userDesiredState),
                    "willAppear": () => viewsAction.onWillAppear(context, settings, coordinates)
                },
                "com.nefrit.youtube.likes": {
                    "keyDown": () => likesAction.onKeyDown(context, settings, coordinates, userDesiredState),
                    "keyUp": () => likesAction.onKeyUp(context, settings, coordinates, userDesiredState),
                    "willAppear": () => likesAction.onWillAppear(context, settings, coordinates)
                }
            };

            const actionToExecute = actions[action]?.[event];
            if (actionToExecute) {
                actionToExecute();
            }
        };

        websocket.onclose = function () {
        };
    }
</script>

</body>

</html>
