<!DOCTYPE HTML>
<html>

<head>
    <title>com.nefrit.youtube.statistics</title>
    <meta charset="utf-8"/>
</head>

<body>
<script>

    const apiKey = "";

    let websocket = null;
    let pluginUUID = null;

    const DestinationEnum = Object.freeze({"HARDWARE_AND_SOFTWARE": 0, "HARDWARE_ONLY": 1, "SOFTWARE_ONLY": 2})

    const viewsAction = {
        type: "com.nefrit.youtube.views",

        onKeyDown: function (context, settings, coordinates, userDesiredState) {
        },

        onKeyUp: function (context, settings, coordinates, userDesiredState) {
            var youtubeVideoId = ""
            if (settings != null && settings.hasOwnProperty('youtubeVideoId')) {
                youtubeVideoId = settings['youtubeVideoId'];
            }

            console.log('youtubeVideoId', youtubeVideoId)
            this.UpdateViews(context, youtubeVideoId)
        },

        onWillAppear: function (context, settings, coordinates) {
            var youtubeVideoId = ""
            if (settings != null && settings.hasOwnProperty('youtubeVideoId')) {
                youtubeVideoId = settings["youtubeVideoId"];
            }
            this.UpdateViews(context, youtubeVideoId)
        },

        SetTitle: function (context, title) {
            const json = {
                "event": "setTitle",
                "context": context,
                "payload": {
                    "title": "" + title,
                    "target": DestinationEnum.HARDWARE_AND_SOFTWARE
                }
            };

            websocket.send(JSON.stringify(json));
        },

        UpdateViews: function (context, youtubeVideoId) {
            const url = "https://www.googleapis.com/youtube/v3/videos?part=statistics&id=" + youtubeVideoId + "&key=" + apiKey;

            console.log(url)
            fetch(url)
                .then(response => response.json())
                .then(responseJSON => {
                    console.log(responseJSON)
                    const viewCount = responseJSON.items[0].statistics.viewCount;
                    this.SetTitle(context, viewCount);
                })
                .catch(error => {
                    console.error(error);
                    this.SetTitle(context, "Ошибка");
                });
        }
    };

    const likesAction = {
        type: "com.nefrit.youtube.likes",

        onKeyDown: function (context, settings, coordinates, userDesiredState) {
        },

        onKeyUp: function (context, settings, coordinates, userDesiredState) {
            var youtubeVideoId = ""
            if (settings != null && settings.hasOwnProperty('youtubeVideoId')) {
                youtubeVideoId = settings['youtubeVideoId'];
            }

            this.UpdateLikes(context, youtubeVideoId)
        },

        onWillAppear: function (context, settings, coordinates) {
            var youtubeVideoId = ""
            if (settings != null && settings.hasOwnProperty('youtubeVideoId')) {
                youtubeVideoId = settings["youtubeVideoId"];
            }
            this.UpdateLikes(context, youtubeVideoId)
        },

        SetTitle: function (context, title) {
            const json = {
                "event": "setTitle",
                "context": context,
                "payload": {
                    "title": "" + title,
                    "target": DestinationEnum.HARDWARE_AND_SOFTWARE
                }
            };

            websocket.send(JSON.stringify(json));
        },

        UpdateLikes: function (context, youtubeVideoId) {
            const url = "https://www.googleapis.com/youtube/v3/videos?part=statistics&id=" + youtubeVideoId + "&key=" + apiKey;

            console.log(url)

            fetch(url)
                .then(response => response.json())
                .then(responseJSON => {
                    const viewCount = responseJSON.items[0].statistics.likeCount;
                    this.SetTitle(context, viewCount);
                })
                .catch(error => {
                    console.error(error);
                    this.SetTitle(context, "Ошибка");
                });
        }
    }

    const subscribersAction = {
        type: "com.nefrit.youtube.subscribers",

        onKeyDown: function (context, settings, coordinates, userDesiredState) {
        },

        onKeyUp: function (context, settings, coordinates, userDesiredState) {
            console.log(settings)
            var youtubeChannel = ""
            if (settings != null && settings.hasOwnProperty('youtubeChannel')) {
                youtubeChannel = settings["youtubeChannel"];
            }
            this.UpdateSubscribers(context, youtubeChannel)
        },

        onWillAppear: function (context, settings, coordinates) {
            var youtubeChannel = ""
            if (settings != null && settings.hasOwnProperty('youtubeChannel')) {
                youtubeChannel = settings["youtubeChannel"];
            }
            this.UpdateSubscribers(context, youtubeChannel)
        },

        SetTitle: function (context, title) {
            const json = {
                "event": "setTitle",
                "context": context,
                "payload": {
                    "title": "" + title,
                    "target": DestinationEnum.HARDWARE_AND_SOFTWARE
                }
            };

            websocket.send(JSON.stringify(json));
        },

        UpdateSubscribers: function (context, youtubeChannel) {
            const url = "https://www.googleapis.com/youtube/v3/channels?part=statistics&id=" + youtubeChannel + "&key=" + apiKey;

            console.log(url)
            fetch(url)
                .then(response => response.json())
                .then(responseJSON => {
                    const subscriberCount = responseJSON.items[0].statistics.subscriberCount;
                    this.SetTitle(context, subscriberCount);
                })
                .catch(error => {
                    console.error(error);
                    this.SetTitle(context, "Ошибка");
                });
        }
    };

    function connectElgatoStreamDeckSocket(inPort, inPluginUUID, inRegisterEvent, inInfo) {
        pluginUUID = inPluginUUID

        websocket = new WebSocket("ws://127.0.0.1:" + inPort);

        function registerPlugin(inPluginUUID) {
            const json = {
                "event": inRegisterEvent,
                "uuid": inPluginUUID
            };

            websocket.send(JSON.stringify(json));
        }

        websocket.onopen = function () {
            registerPlugin(pluginUUID);
        };

        websocket.onmessage = function (evt) {
            const jsonObj = JSON.parse(evt.data);
            const event = jsonObj['event'];
            const action = jsonObj['action'];
            const context = jsonObj['context'];

            const jsonPayload = jsonObj['payload'];
            const settings = jsonPayload['settings'];
            const coordinates = jsonPayload['coordinates'];
            const userDesiredState = jsonPayload['userDesiredState'];


            const actions = {
                "com.nefrit.youtube.views": {
                    "keyDown": () => viewsAction.onKeyDown(context, settings, coordinates, userDesiredState),
                    "keyUp": () => viewsAction.onKeyUp(context, settings, coordinates, userDesiredState),
                    "willAppear": () => viewsAction.onWillAppear(context, settings, coordinates)
                },
                "com.nefrit.youtube.likes": {
                    "keyDown": () => likesAction.onKeyDown(context, settings, coordinates, userDesiredState),
                    "keyUp": () => likesAction.onKeyUp(context, settings, coordinates, userDesiredState),
                    "willAppear": () => likesAction.onWillAppear(context, settings, coordinates)
                },
                "com.nefrit.youtube.subscribers": {
                    "keyDown": () => subscribersAction.onKeyDown(context, settings, coordinates, userDesiredState),
                    "keyUp": () => subscribersAction.onKeyUp(context, settings, coordinates, userDesiredState),
                    "willAppear": () => subscribersAction.onWillAppear(context, settings, coordinates)
                }
            };

            const actionToExecute = actions[action]?.[event];
            if (actionToExecute) {
                actionToExecute();
            }
        };

        websocket.onclose = function () {
        };
    }

</script>

</body>

</html>
